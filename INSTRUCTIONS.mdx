# Tests de la persistance

### ğŸ’¡ Tester la couche de persistance (Sans `Mock`)

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans la section prÃ©cÃ©dente, nous avons testÃ© les services en `mockant` la persistance. Cela permet de tester la logique mÃ©tier, autorisation, validation etcâ€¦ Mais on ne peut pas dÃ©tecter dâ€™Ã©ventuels problÃ¨mes SQL, car rien nâ€™est exÃ©cutÃ©.

Plusieurs approches existent pour rÃ©soudre ce problÃ¨me :

- Avoir une `BDD` dÃ©diÃ©e Ã  lâ€™exÃ©cution des tests
- Avoir un utilitaire qui permet dâ€™avoir une `BDD` proche de `Postgres` embarquÃ©e comme
  - [pg-mem](https://www.npmjs.com/package/pg-mem)
  - [test-container](https://testcontainers.com/modules/postgresql/)

Dans un premier temps, nous allons ici faire nos tests avec une `BDD` `Postgres` dÃ©diÃ©e

- Etape 1 :

Nous allons donc nous assurer dâ€™avoir une `URL` pour la base de tests `.env.test`

```bash
#.env.test
POSTGRES_URL="postgres://default:hostname:5432/verceldb?sslmode=require"
```

Il va falloir ensuite sâ€™assurer que les tests sâ€™exÃ©cutent bien sur lâ€™instance de tests. Pour cela nous allons logger lâ€™index de `Drizzle`

```tsx
import * as todos from './todos'
import * as users from './users'
import * as categories from './categories'
import * as products from './products'
import * as accounts from './accounts'

const bddUrl = process.env.POSTGRES_URL ?? ''
const env = process.env.NODE_ENV ?? ''
console.log('Drizzle ENV:', env)
console.log('Drizzle schema bddUrl:', bddUrl)

const pool = postgres(bddUrl, {max: 1})

const db = drizzle(pool, {
  schema: {...todos, ...users, ...categories, ...products, ...accounts},
})

export default db
```

- Etape 2 :

Il nous faut un fichier de configuration `drizzle` spÃ©cial pour les tests avec une initialisation des variables dâ€™environnement pour lâ€™environnement de tests.

Note : Lâ€™`URL` pourrait Ãªtre mise en dur dans `url:` pour Ãªtre sÃ»r Ã  100% quâ€™un autre environnement nâ€™est pas chargÃ©

```tsx
import {defineConfig} from 'drizzle-kit'
import initDotEnv from '../scripts/env'
initDotEnv('test')

export default defineConfig({
  schema: './src/db/schema/*',
  out: './drizzle/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.POSTGRES_URL as string,
  },
  verbose: true,
  strict: true,
  introspect: {
    casing: 'camel',
  },
})
```

- Etape 3 : Avoir des scripts permettant dâ€™avoir une base de donnÃ©es vide entre chaque test, par exemple :

```tsx
beforeAll(async () => {
    await initDrizzle() // Assure-toi que la base de donnÃ©es est propre
  })
//
export async function initDrizzle() {
  if (process.env.NODE_ENV !== 'production') {
    await generateDb() // appel drizzle-kit generate
    await migrateDb() // appel drizzle-kit migrate
    await truncateTables() // truncate toutes les tables
  }
}
```

Note : Ces fonctions seront fournies pour la suite de lâ€™exercice.

## Exercice

Dans cet exercice, il y a un test qui permet de tester la crÃ©ation dâ€™un utilisateur

```tsx
test('should create a new user', async () => {
    const newUser: CreateUser = {
      name: faker.person.firstName(),
      email: 'test@test.com',
      password: faker.internet.password(),
      role: 'USER',
      image: null,
      emailVerified: null,
    }
    const createdUser = await createUserDao(newUser)
    expect(createdUser).toStrictEqual({
      ...newUser,
      id: createdUser.id,
    })
  })
```

Pour rappel : lâ€™email doit Ãªtre unique dans la table `email: text('email').unique()`

```tsx
export const users = pgTable('user', {
  id: uuid('id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),
  email: text('email').unique(),
```

Ce qui veut dire que si un test sâ€™exÃ©cute Ã  nouveau, une erreur apparaitra.

```tsx
PostgresError: duplicate key value violates unique constraint "user_email_unique"
```

- **ğŸ¶**Dans cet exercice, tu vas devoir, dans un premier temps, appeler \*\*\*\*`initDrizzle` avant chaque test
  - `generateDb` (gÃ©nÃ¨re les scripts sql : `drizzle-kit generate`)
  - `migrateDb` (gÃ©nÃ¨re les scripts sql : `drizzle-kit migrate`)
  - `truncateTables` (vide toutes les tables)

```tsx
export async function initDrizzle() {
  if (process.env.NODE_ENV !== 'production') {
    await generateDb()
    await migrateDb()
    await truncateTables()
  }
}
```

- **ğŸ¶** Continue sur tous les test de `users`

### **Liste des tests :**

1. **Devrait crÃ©er un nouvel utilisateur**

   VÃ©rifie qu'un nouvel utilisateur peut Ãªtre crÃ©Ã© avec les donnÃ©es fournies.

2. **Devrait lire tous les utilisateurs**

   VÃ©rifie que tous les utilisateurs peuvent Ãªtre rÃ©cupÃ©rÃ©s.

3. **Devrait lire un utilisateur par ID**

   VÃ©rifie qu'un utilisateur spÃ©cifique peut Ãªtre rÃ©cupÃ©rÃ© en utilisant son ID.

4. **Devrait rÃ©cupÃ©rer un utilisateur par email**

   VÃ©rifie qu'un utilisateur peut Ãªtre rÃ©cupÃ©rÃ© en utilisant son email.

5. **Devrait crÃ©er un utilisateur, un compte et une session**

   VÃ©rifie qu'un utilisateur, son compte, et sa session sont crÃ©Ã©s simultanÃ©ment.

6. **Devrait lancer une erreur et ne pas crÃ©er d'utilisateur avec une transaction**

   VÃ©rifie que la crÃ©ation d'un utilisateur Ã©choue si une contrainte (comme une session existante) n'est pas respectÃ©e, et qu'aucune donnÃ©e n'est enregistrÃ©e dans la base de donnÃ©es.

Fichiers

- `src/db/__tests__/user-repository.test.ts`

## Bonus

### 1. ğŸš€ Test ProductRepository

- **ğŸ¶ ImplÃ©mente les tests `product`**

### **Liste des tests :**

1. **Devrait crÃ©er un nouvel utilisateur**

   VÃ©rifie qu'un nouvel utilisateur peut Ãªtre crÃ©Ã© avec les donnÃ©es fournies.

2. **Devrait lire tous les utilisateurs**

   VÃ©rifie que tous les utilisateurs peuvent Ãªtre rÃ©cupÃ©rÃ©s.

3. **Devrait lire un utilisateur par ID**

   VÃ©rifie qu'un utilisateur spÃ©cifique peut Ãªtre rÃ©cupÃ©rÃ© en utilisant son ID.

4. **Devrait rÃ©cupÃ©rer un utilisateur par email**

   VÃ©rifie qu'un utilisateur peut Ãªtre rÃ©cupÃ©rÃ© en utilisant son email.

5. **Devrait crÃ©er un utilisateur, un compte et une session**

   VÃ©rifie qu'un utilisateur, son compte, et sa session sont crÃ©Ã©s simultanÃ©ment.

6. **Devrait lancer une erreur et ne pas crÃ©er d'utilisateur avec une transaction**

   VÃ©rifie que la crÃ©ation d'un utilisateur Ã©choue si une contrainte (comme une session existante) n'est pas respectÃ©e, et qu'aucune donnÃ©e n'est enregistrÃ©e dans la base de donnÃ©es.

Fichiers

- `src/db/__tests__/product-repository.test.ts`

### 2. ğŸš€ NÅ“ud `root`

PlutÃ´t que dâ€™avoir le nÅ“ud `root` dans le code HTML, vois si tu peux le crÃ©er en utilisant Ã©galement JavaScript.

Fichiers

- `exercise/about/page`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=8.Next%20Testing&entry.533578441=06%20Tests-peristance).
