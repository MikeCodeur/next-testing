# Tests Persistence - Docker

### 💡 Description longue de l'exercice

## 📝 Tes notes

Detaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Précédemment nous avons utiliser une vraie base de données. Cela nécessite d’installer, configurer, et maintenant une instance Postgres. De plus si plusieurs utilisateurs / CI / utilisent cette instance au même moment cela peut poser des problèmes. Pour resoudre ce problème le mieux est d'avoir une instance embarquée qui va s’initialiser lors des test puis sera détruite a la fin.

Pour cela il existe [testcontainer](https://testcontainers.com/modules/postgresql/?language=nodejs) basé sur [Docker](https://www.docker.com/) qui va permette de démarrer une instance de `postgres` localement.

- Ajout dans le projet

```tsx
pnpm add -D testcontainers @testcontainers/postgresql
```

- Setup du container

```tsx
//setup-container.ts
export async function setupTestDatabase() {
  const container = await new PostgreSqlContainer()
    .withDatabase('test-db')
    .withUsername('test-user')
    .withPassword('test-password')
    .start()

  const pool = new Pool({
    connectionString: container.getConnectionUri(),
  })

  // Utilisation du pool pg docker
}
```

⚠️ Pour fonctionner Docker doit être configuré correctement

- [Windows](https://docs.docker.com/desktop/setup/install/windows-install/)
- [Mac](https://docs.docker.com/desktop/setup/install/mac-install/)
- [Linux](https://docs.docker.com/desktop/setup/install/linux/)

Exemple WSL / Unbuntu

```bash
#installe Docker
sudo apt-get update
sudo apt-get install docker.io

#démarre Docker
sudo systemctl start docker

#démarre Docker automatiquement au demarrage
sudo systemctl enable docker

#redémarre le service Docker
sudo systemctl restart docker

#Ajoute ton utilisateur (remplacé par $USER) au groupe docker
sudo usermod -aG docker $USER
```

⚠️ ps : Il faut souvent reboot le system complet la première fois

## Exercice

Le premier étape consiste a ne plus utiliser le pool de connexion de notre application mais celui de docker

```tsx
// db/schema
const bddUrl = process.env.POSTGRES_URL ?? ''
const env = process.env.NODE_ENV ?? ''

export const schema = {
  ...todos,
  ...users,
  ...categories,
  ...products,
  ...accounts,
}
const pool = postgres(bddUrl, {max: 1})
const db = drizzle(pool, {
  schema,
})

export default db
```

- **🐶 Step 1 : Edite le fichier** `setup-container.ts` pour creer un `Pool` et un Instance `Drizzle` connecté a `docker`
- **🐶 Step 2 : Mock `@/db/schema` dans les tests utiliser la bonne instance**

_Note : Pour être sur que les tests ne n’exécutent pas sur l’instance précédente , supprime/renomme/commente les fichiers `.env.test`. Pour cette exercice nous avons volontairement générer une erreur si on essaye d’utiliser `drizzle` en mode test_

```tsx
//src/db/schema/index.ts
if (process.env.NODE_ENV === 'test') {
  throw new Error('Do not use this schema in test environment')
}
```

C’est donc normal si les tests des exercices précédents échouent

Fichiers

- `src/db/__tests__/setup-container.ts`
- `src/db/__tests__/product-repo-docker.test.ts`

## Bonus

### 1. 🚀 Fait la même chose pour d’autres repository

## Aller plus loin

📑 Le lien vers la doc [https://testcontainers.com/modules/postgresql/?language=nodejs](https://testcontainers.com/modules/postgresql/?language=nodejs)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-react-avis).
