# Tests Persistence - Docker

### ğŸ’¡ Description longue de l'exercice

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

PrÃ©cÃ©demment nous avons utiliser une vraie base de donnÃ©es. Cela nÃ©cessite dâ€™installer, configurer, et maintenant une instance Postgres. De plus si plusieurs utilisateurs / CI / utilisent cette instance au mÃªme moment cela peut poser des problÃ¨mes. Pour resoudre ce problÃ¨me le mieux est d'avoir une instance embarquÃ©e qui va sâ€™initialiser lors des test puis sera dÃ©truite a la fin.

Pour cela il existe [testcontainer](https://testcontainers.com/modules/postgresql/?language=nodejs) basÃ© sur [Docker](https://www.docker.com/) qui va permette de dÃ©marrer une instance de `postgres` localement.

- Ajout dans le projet

```tsx
pnpm add -D testcontainers @testcontainers/postgresql
```

- Setup du container

```tsx
//setup-container.ts
export async function setupTestDatabase() {
  const container = await new PostgreSqlContainer()
    .withDatabase('test-db')
    .withUsername('test-user')
    .withPassword('test-password')
    .start()

  const pool = new Pool({
    connectionString: container.getConnectionUri(),
  })

  // Utilisation du pool pg docker
}
```

âš ï¸ Pour fonctionner Docker doit Ãªtre configurÃ© correctement

- [Windows](https://docs.docker.com/desktop/setup/install/windows-install/)
- [Mac](https://docs.docker.com/desktop/setup/install/mac-install/)
- [Linux](https://docs.docker.com/desktop/setup/install/linux/)

Exemple WSL / Unbuntu

```bash
#installe Docker
sudo apt-get update
sudo apt-get install docker.io

#dÃ©marre Docker
sudo systemctl start docker

#dÃ©marre Docker automatiquement au demarrage
sudo systemctl enable docker

#redÃ©marre le service Docker
sudo systemctl restart docker

#Ajoute ton utilisateur (remplacÃ© par $USER) au groupe docker
sudo usermod -aG docker $USER
```

âš ï¸ ps : Il faut souvent reboot le system complet la premiÃ¨re fois

## Exercice

Le premier Ã©tape consiste a ne plus utiliser le pool de connexion de notre application mais celui de docker

```tsx
// db/schema
const bddUrl = process.env.POSTGRES_URL ?? ''
const env = process.env.NODE_ENV ?? ''

export const schema = {
  ...todos,
  ...users,
  ...categories,
  ...products,
  ...accounts,
}
const pool = postgres(bddUrl, {max: 1})
const db = drizzle(pool, {
  schema,
})

export default db
```

- **ğŸ¶ Step 1 : Edite le fichier** `setup-container.ts` pour creer un `Pool` et un Instance `Drizzle` connectÃ© a `docker`
- **ğŸ¶ Step 2 : Mock `@/db/schema` dans les tests utiliser la bonne instance**

_Note : Pour Ãªtre sur que les tests ne nâ€™exÃ©cutent pas sur lâ€™instance prÃ©cÃ©dente , supprime/renomme/commente les fichiers `.env.test`. Pour cette exercice nous avons volontairement gÃ©nÃ©rer une erreur si on essaye dâ€™utiliser `drizzle` en mode test_

```tsx
//src/db/schema/index.ts
if (process.env.NODE_ENV === 'test') {
  throw new Error('Do not use this schema in test environment')
}
```

Câ€™est donc normal si les tests des exercices prÃ©cÃ©dents Ã©chouent

Fichiers

- `src/db/__tests__/setup-container.ts`
- `src/db/__tests__/product-repo-docker.test.ts`

## Bonus

### 1. ğŸš€ Fait la mÃªme chose pour dâ€™autres repository

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://testcontainers.com/modules/postgresql/?language=nodejs](https://testcontainers.com/modules/postgresql/?language=nodejs)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-react-avis).
